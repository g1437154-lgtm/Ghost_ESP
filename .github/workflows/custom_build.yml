name: Custom Build

on:
  workflow_dispatch:
    inputs:
      board_type:
        description: 'ESP32 Board Type'
        required: true
        type: choice
        options:
          - esp32
          - esp32s2
          - esp32s3
          - esp32c3
          - esp32c6

      display_type:
        description: 'Display Type'
        required: true
        type: choice
        options:
          - custom
          - none
          - MarauderV4_FlipperHub
          - MarauderV6_AwokDual
          - AwokMini
          - ESP32-S3-Cardputer
          - LillyGoTWatch_S3
          - CYD2USB
          - CYDMicroUSB
          - CYDDualUSB
          - CYD2USB2.4_Inch
          - Waveshare_LCD
          - Crowtech_LCD

      screen_width:
        description: 'Screen Width (custom display only)'
        required: false
        type: string

      screen_height:
        description: 'Screen Height (custom display only)'
        required: false
        type: string

      use_touch:
        description: 'Enable Touch Support'
        required: true
        type: boolean
        default: false

      flash_size:
        description: 'Flash Size'
        required: true
        type: choice
        options:
          - 4MB
          - 8MB
          - 16MB
        default: '4MB'

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install ESP-IDF
        run: |
          sudo apt-get update
          sudo apt-get install -y wget git flex bison gperf python3-pip python3-setuptools cmake ninja-build ccache libffi-dev libssl-dev dfu-util
          git clone -b v5.3.1 --depth 1 https://github.com/espressif/esp-idf.git ~/esp-idf
          ~/esp-idf/install.sh

      - name: Select SDK Config
        run: |
          # Preconfigured displays
          case "${{ github.event.inputs.display_type }}" in
            "MarauderV4_FlipperHub") cp configs/sdkconfig.marauderv4 sdkconfig.defaults ;;
            "MarauderV6_AwokDual") cp configs/sdkconfig.marauderv6 sdkconfig.defaults ;;
            "AwokMini") cp configs/sdkconfig.awokmini sdkconfig.defaults ;;
            "ESP32-S3-Cardputer") cp configs/sdkconfig.cardputer sdkconfig.defaults ;;
            "LillyGoTWatch_S3") cp configs/sdkconfig.S3TWatch sdkconfig.defaults ;;
            "CYD2USB") cp configs/sdkconfig.CYD2USB sdkconfig.defaults ;;
            "CYDMicroUSB") cp configs/sdkconfig.CYDMicroUSB sdkconfig.defaults ;;
            "CYDDualUSB") cp configs/sdkconfig.CYDDualUSB sdkconfig.defaults ;;
            "CYD2USB2.4_Inch") cp configs/sdkconfig.CYD2USB2.4Inch sdkconfig.defaults ;;
            "Waveshare_LCD") cp configs/sdkconfig.waveshare7inch sdkconfig.defaults ;;
            "Crowtech_LCD") cp configs/sdkconfig.crowtech7inch sdkconfig.defaults ;;
            *)
              cp configs/sdkconfig.default.${{ github.event.inputs.board_type }} sdkconfig.defaults
              ;;
          esac

          # Custom display size
          if [ "${{ github.event.inputs.display_type }}" = "custom" ]; then
            cat >> sdkconfig.defaults <<EOF
CONFIG_WITH_SCREEN=y
CONFIG_TFT_WIDTH=${{ github.event.inputs.screen_width }}
CONFIG_TFT_HEIGHT=${{ github.event.inputs.screen_height }}
EOF
          fi

          # Touch support
          if [ "${{ github.event.inputs.use_touch }}" = "true" ]; then
            echo "CONFIG_USE_TOUCHSCREEN=y" >> sdkconfig.defaults
          fi

          # Flash size
          echo "CONFIG_ESPTOOLPY_FLASHSIZE=\"${{ github.event.inputs.flash_size }}\"" >> sdkconfig.defaults

      - name: Export IDF
        run: |
          . ~/esp-idf/export.sh
          export IDF_TARGET=${{ github.event.inputs.board_type }}
          echo "IDF_TARGET=${{ github.event.inputs.board_type }}" >> $GITHUB_ENV

      - name: Build Project
        env:
          SDKCONFIG_DEFAULTS: "sdkconfig.defaults"
        run: |
          . ~/esp-idf/export.sh
          idf.py clean
          idf.py build

      - name: Package Firmware
        run: |
          mkdir -p output
          cp build/*.bin output/ || true
          cp build/partition_table/partition-table.bin output/ || true
          zip -r firmware.zip output

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: firmware.zip
